{%- comment -%}
  Build boxes JSON from structured inputs if any are enabled; otherwise fall back to textarea JSON.
{%- endcomment -%}
{% assign boxes_concat = '' %}
{% for i in (1..3) %}
  {% assign key_enabled = 'box' | append: i | append: '_enabled' %}
  {% assign enabled = block.settings[key_enabled] %}
  {% if enabled %}
    {% assign key_code = 'box' | append: i | append: '_code' %}
    {% assign key_name = 'box' | append: i | append: '_name' %}
    {% assign key_L = 'box' | append: i | append: '_L_mm' %}
    {% assign key_W = 'box' | append: i | append: '_W_mm' %}
    {% assign key_H = 'box' | append: i | append: '_H_mm' %}
    {% assign key_MW = 'box' | append: i | append: '_max_weight_g' %}

    {% assign code = block.settings[key_code] | default: '' %}
    {% assign name = block.settings[key_name] | default: '' %}
    {% assign L = block.settings[key_L] | default: 0 %}
    {% assign W = block.settings[key_W] | default: 0 %}
    {% assign H = block.settings[key_H] | default: 0 %}
    {% assign MW = block.settings[key_MW] | default: 0 %}
    {% capture one_box %}{"code":"{{ code }}","name":"{{ name }}","inner_mm":{"L":{{ L }},"W":{{ W }},"H":{{ H }}},"max_weight_g":{{ MW }}}{% endcapture %}
    {% if boxes_concat != '' %}{% assign boxes_concat = boxes_concat | append: ',' %}{% endif %}
    {% assign boxes_concat = boxes_concat | append: one_box %}
  {% endif %}
{% endfor %}

{% if boxes_concat == '' %}
  {% assign boxes_attr = block.settings.boxes_json | escape %}
{% else %}
  {% capture boxes_attr_raw %}[{{ boxes_concat }}]{% endcapture %}
  {% assign boxes_attr = boxes_attr_raw | escape %}
{% endif %}

<div id="box-meter-{{ block.id }}" class="box-meter" data-block="box-meter" data-boxes='{{ boxes_attr }}'>
  {% assign v = product.selected_or_first_available_variant %}

  {% assign p_len = nil %}
  {% assign p_wid = nil %}
  {% assign p_hei = nil %}
  {% assign p_wgt = nil %}

  {%- comment -%} Prefer product or variant metafields based on setting {%- endcomment -%}
  {% assign prefer_product = block.settings.prefer_product %}

  {% if prefer_product %}
    {% if product.metafields.packaging.length_mm != blank %}
      {% assign p_len = product.metafields.packaging.length_mm.value %}
    {% elsif v.metafields.packaging.length_mm != blank %}
      {% assign p_len = v.metafields.packaging.length_mm.value %}
    {% endif %}

    {% if product.metafields.packaging.width_mm != blank %}
      {% assign p_wid = product.metafields.packaging.width_mm.value %}
    {% elsif v.metafields.packaging.width_mm != blank %}
      {% assign p_wid = v.metafields.packaging.width_mm.value %}
    {% endif %}

    {% if product.metafields.packaging.height_mm != blank %}
      {% assign p_hei = product.metafields.packaging.height_mm.value %}
    {% elsif v.metafields.packaging.height_mm != blank %}
      {% assign p_hei = v.metafields.packaging.height_mm.value %}
    {% endif %}

    {% if product.metafields.packaging.weight_g != blank %}
      {% assign p_wgt = product.metafields.packaging.weight_g.value %}
    {% elsif v.metafields.packaging.weight_g != blank %}
      {% assign p_wgt = v.metafields.packaging.weight_g.value %}
    {% endif %}
  {% else %}
    {% if v.metafields.packaging.length_mm != blank %}
      {% assign p_len = v.metafields.packaging.length_mm.value %}
    {% elsif product.metafields.packaging.length_mm != blank %}
      {% assign p_len = product.metafields.packaging.length_mm.value %}
    {% endif %}

    {% if v.metafields.packaging.width_mm != blank %}
      {% assign p_wid = v.metafields.packaging.width_mm.value %}
    {% elsif product.metafields.packaging.width_mm != blank %}
      {% assign p_wid = product.metafields.packaging.width_mm.value %}
    {% endif %}

    {% if v.metafields.packaging.height_mm != blank %}
      {% assign p_hei = v.metafields.packaging.height_mm.value %}
    {% elsif product.metafields.packaging.height_mm != blank %}
      {% assign p_hei = product.metafields.packaging.height_mm.value %}
    {% endif %}

    {% if v.metafields.packaging.weight_g != blank %}
      {% assign p_wgt = v.metafields.packaging.weight_g.value %}
    {% elsif product.metafields.packaging.weight_g != blank %}
      {% assign p_wgt = product.metafields.packaging.weight_g.value %}
    {% endif %}
  {% endif %}

  <div
    data-role="bm-data"
    data-len="{{ p_len | default: 0 }}"
    data-wid="{{ p_wid | default: 0 }}"
    data-hei="{{ p_hei | default: 0 }}"
    data-wgt="{{ p_wgt | default: 0 }}"
    data-rotate="{{ block.settings.allow_rotation }}">
  </div>

  <details open>
    <summary>{{ block.settings.title }}</summary>
    <div data-role="bm-output"></div>
  </details>
</div>

{{ 'box_meter.css' | asset_url | stylesheet_tag }}
<script src="{{ 'box_meter.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Box Meter",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Box Meter"
    },
    { "type": "header", "content": "Boxes (no JSON needed)" },
    { "type": "paragraph", "content": "Enable and fill in any boxes you need. Leave disabled boxes empty." },
    { "type": "checkbox", "id": "box1_enabled", "label": "Enable Box 1", "default": true },
    { "type": "text", "id": "box1_name", "label": "Box 1 name", "default": "Small Box" },
    { "type": "text", "id": "box1_code", "label": "Box 1 code", "default": "B1" },
    { "type": "number", "id": "box1_L_mm", "label": "Box 1 inner length (mm)", "default": 200 },
    { "type": "number", "id": "box1_W_mm", "label": "Box 1 inner width (mm)", "default": 150 },
    { "type": "number", "id": "box1_H_mm", "label": "Box 1 inner height (mm)", "default": 100 },
    { "type": "number", "id": "box1_max_weight_g", "label": "Box 1 max weight (g)", "default": 5000 },

    { "type": "checkbox", "id": "box2_enabled", "label": "Enable Box 2", "default": true },
    { "type": "text", "id": "box2_name", "label": "Box 2 name", "default": "Medium Box" },
    { "type": "text", "id": "box2_code", "label": "Box 2 code", "default": "B2" },
    { "type": "number", "id": "box2_L_mm", "label": "Box 2 inner length (mm)", "default": 300 },
    { "type": "number", "id": "box2_W_mm", "label": "Box 2 inner width (mm)", "default": 200 },
    { "type": "number", "id": "box2_H_mm", "label": "Box 2 inner height (mm)", "default": 150 },
    { "type": "number", "id": "box2_max_weight_g", "label": "Box 2 max weight (g)", "default": 12000 },

    { "type": "checkbox", "id": "box3_enabled", "label": "Enable Box 3", "default": true },
    { "type": "text", "id": "box3_name", "label": "Box 3 name", "default": "Large Box" },
    { "type": "text", "id": "box3_code", "label": "Box 3 code", "default": "B3" },
    { "type": "number", "id": "box3_L_mm", "label": "Box 3 inner length (mm)", "default": 400 },
    { "type": "number", "id": "box3_W_mm", "label": "Box 3 inner width (mm)", "default": 300 },
    { "type": "number", "id": "box3_H_mm", "label": "Box 3 inner height (mm)", "default": 200 },
    { "type": "number", "id": "box3_max_weight_g", "label": "Box 3 max weight (g)", "default": 20000 },

    

    { "type": "header", "content": "Advanced (optional)" },
    {
      "type": "textarea",
      "id": "boxes_json",
      "label": "Box Definitions (JSON) â€” supports inner_mm (mm) or inner_in (inches)",
      "default": "[\n  {\n    \"code\": \"B1\",\n    \"name\": \"Small Box\",\n    \"inner_mm\": { \"L\": 200, \"W\": 150, \"H\": 100 },\n    \"max_weight_g\": 5000\n  },\n  {\n    \"code\": \"B2\",\n    \"name\": \"Medium Box\",\n    \"inner_mm\": { \"L\": 300, \"W\": 200, \"H\": 150 },\n    \"max_weight_g\": 12000\n  },\n  {\n    \"code\": \"B3\",\n    \"name\": \"Large Box\",\n    \"inner_mm\": { \"L\": 400, \"W\": 300, \"H\": 200 },\n    \"max_weight_g\": 20000\n  }\n]"
    },
    {
      "type": "checkbox",
      "id": "allow_rotation",
      "label": "Place product by rotating inside the box",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "prefer_product",
      "label": "Prefer product metafields over variant",
      "default": true
    }
  ]
}
{% endschema %}
